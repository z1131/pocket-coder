services:
  # Nginx Gateway - 唯一的公网入口
  nginx-gateway:
    image: nginx:alpine
    container_name: pocket-coder-gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # 挂载自定义 Nginx 配置
      - ./nginx-gateway.conf:/etc/nginx/conf.d/default.conf
      # 挂载 SSL 证书 (注意：这里假设在服务器上运行时的路径)
      # 在本地开发时可能需要注释掉或指向本地证书
      - /etc/nginx/certs:/etc/nginx/certs
    depends_on:
      - frontend
      - server
    networks:
      - pocket-coder-net
    restart: unless-stopped

  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: pocket-coder-frontend
    networks:
      - pocket-coder-net
    restart: unless-stopped

  # 后端服务
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: pocket-coder-server
    environment:
      - SERVER_PORT=${SERVER_PORT}
      - SERVER_MODE=${SERVER_MODE}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_PORT=${MYSQL_PORT}
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_USERNAME=${REDIS_USERNAME}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - QWEN_API_KEY=${QWEN_API_KEY}
    networks:
      - pocket-coder-net
    restart: unless-stopped

networks:
  pocket-coder-net:
    driver: bridge